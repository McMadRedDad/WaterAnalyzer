Qt/C++ frontend communicates with Python backend via HTTP messages. JSON objects constructed according to this protocol are sent in message bodies.

Requests for command execution are sent as POST HTTP/1.1 to /api/`command` endpoint.
Requests for particular resources (image preview, spatial index image, etc.) are sent as GET HTTP/2 to /resources/`type`/`id` endpoint.

There are two layers of error checking.
Firstly, overall request validity on the HTTP level is checked. This includes correct set of headers, valid JSON body, etc. If any error is caught, a response is sent immediately with an empty body and a "Reason" header containing a description of the error. Else, the protocol proceeds to the next layer.
Secondly, the JSON body itself, if applicable, is checked according to the main part of this protocol and an appropriate response is generated. Alongside the JSON errors, HTTP status codes are utilized as a general clue on the result of the request.

## Mandatory HTTP headers

Command execution requests must include the following HTTP headers:
- Content-Type: application/json; charset=utf-8
- Content-Length: `request's body length in bytes`
- Accept: application/json; charset=utf-8
- Protocol-Version: `this protocol's version`
- Request-ID: `request id`
Command execution responses must include the following HTTP headers:
- Server: `HTTP server`
- Content-Type: application/json; charset=utf-8
- Content-Length: `response's body length in bytes`
- Protocol-Version: `this protocol's version`
- Request-ID: `request id`

Resource requests must include the following HTTP headers:
- Accept: `supported formats`
- Protocol-Version: `this protocol's version`
- Request-ID: `request id`
Resource responses must include the following HTTP headers:
- Server: `HTTP server`
- Content-Type: `resource format`
- Content-Length: `response's body length in bytes`
- Protocol-Version: `this protocol's version`
- Request-ID: `request id`

Any additional headers generated by HTTP servers and clients **do not** violate this protocol.
If not all mandatory headers are present in a request, HTTP server constructs an HTTP 400 Bad Request response with an empty body, the "Request-ID" header, if present, and a "Reason" header:

Reason: Invalid HTTP Request. Headers "`missing headers`" are missing in the request.

If only the "Content-Length" header is missing, HTTP 411 Length Required is sent instead withthe following "Reason" header:

Reason: Invalid HTTP request. "Content-Length" header must be provided.

The mandatory headers' values are considered valid if:
- Content-Type and Accept equal to "application/json; charset=utf-8" OR "application/json;charset=utf-8"
- Content-Length is of integer type and equals to the size of the message body in bytes
- Protocol-Version equals to the actual version of this protocol
- Request-ID is of integer type

If any header's value is invalid, an HTTP 400 Bad Request response with an empty body and one of the following "Reason" headers is sent:

Reason: Invalid value "`invalid value`" of "Content-Type" header: must be "application/json; charset=utf-8" or "application/json;charset=utf-8".
Reason: Invalid value "`invalid value`" of "Accept" header: must be "application/json; charset=utf-8" or "application/json;charset=utf-8".
Reason: Invalid type for "Content-Length" header: must be of integer type.
Reason: Invalid value "`provided length`" for "Content-Length" header: does not equal to message body's length in bytes (actual length is `actual length`).
Reason: Invalid protocol version "`provided version`" in "Protocol-Version" header: used protocol version is "`used protocol version`".
Reason: Invalid type for "Request-ID" header: must be of integer type.

## HTTP request body validation

After successfully passing HTTP headers check, the request proceeds to body validation. At this point, it is only checked if body is of the correct type and in a valid format.

For command execution (HTTP POST) requests it is checked if a body is a valid JSON. If not, an HTTP 400 Bad Request with an empty body and the "Reason" header is sent:

Reason: The request's body is not a valid JSON.

For resource (HTTP GET) requests it is checked if body is empty. If not, an HTTP 400 Bad Request with an empty body and the "Reason" header is sent:

Reason: The request's body must be empty for resource requests.

If the request passed body validation, it proceeds to the second layer of error checking related to the JSON part of this protocol.

## Supported commands

1. PING - check connection
2. SHUTDOWN - turn the server off
3. import_gtiff - load and cache GeoTiff file
4. export_gtiff - save calculated index as GeoTiff file
5. calc_preview - request rgb values to render as a preview. Upon recieving a successful response, the client constructs an HTTP request, sends it over a separate channel and waits for an HTTP response containing the binary representation of the preview
6. calc_index - create a spectral index and cache it

## Message structure

All JSON documents (objects) consist of 5 keys:

**REQUEST**
- `proto_version`     - [STRING] in format of  "x.y.z" indicating the version of the protocol used
- `server_version`    - [STRING] in format of  "x.y.z" indicating the version of the server running
- `id`                - [INT]    id of request
- `operation`         - [STRING] type of operation to perform on the backend
- `parameters`        - [OBJECT] parameters to use for `operation`

**RESPONSE**
- `proto_version`     - [STRING] in format of  "x.y.z" indicating the version of the protocol used
- `server_version`    - [STRING] in format of  "x.y.z" indicating the version of the server running
- `id`                - [INT]    id of respective request
- `status`            - [INT]    number indicating success or an error
- `result`            - [OBJECT] data generated by respective `operation`, if applicable

If there are no `parameters` or `result`, an empty object is sent.

Status codes follow these general rules:
- 0 means requested operation was successfully performed.
- 1xxxx means invalid request (checks for types and request structure).
- 2xxxx means an error on the backend side (logic/other error).
- 100xx and 200xx refer to codes common for all operations
- 1yyxx and 2yyxx refer to codes specific for operation `yy`, numbered as in Supported commands, 0-prefixed

Below are specifics for requests and responses for each supported command. Common keys and status codes are not specified for each operation.

### Common status codes

1. Invalid request structure:
    - `status` - 10000
    - `result` - { "error": "key '`unknown key`' is unknown" }
    -  HTTP 400 Bad Request
2. Invalid request structure:
    - `status` - 10001
    - `result` - { "error": "keys '`missing keys`' are not specified" }
    -  HTTP 400 Bad Request
3. Invalid protocol version string:
    - `status` - 10002
    - `result` - { "error": "invalid protocol version string: '`invalid string`'" }
    -  HTTP 400 Bad Request
4. Invalid server version string:
    - `status` - 10003
    - `result` - { "error": "invalid server version string: '`invalid string`'" }
    -  HTTP 400 Bad Request
5. Invalid id:
    - `status` - 10004
    - `result` - { "error": "invalid request id: '`invalid id`'" }
    -  HTTP 400 Bad Request
6. Unknown operation:
    - `status` - 10005
    - `result` - { "error": "unknown operation '`operation`' requested" }
    -  HTTP 400 Bad Request
7. Invalid parameters:
    - `status` - 10006
    - `result` - { "error": "invalid `parameters` key: must be of JSON object type }
    -  HTTP 400 Bad Request
8. Invalid parameters (missing key in `parameters` object):
    - `status` - 10007
    - `result` - { "error": "keys '`missing keys`' are not specified in `parameters` for `operation` operation }
    -  HTTP 400 Bad Request
9. Invalid parameters (unknown key in `parameters` object):
    - `status` - 10008
    - `result` - { "error": "unknown key '`unknown key`' in `parameters` for `operation` operation" }
    -  HTTP 400 Bad Request
10. Incorrect protocol version:
    - `status` - 10009
    - `result` - { "error": "incorrect protocol version: '`requested protocol version`'. The current protocol version is `used protocol version`" }
    -  HTTP 400 Bad Request
11. Mismatching keys:
    - `status` - 10010
    - `result` - { "error": "values '`mismatched key`' do not match in request and response" }
    -  HTTP 400 Bad Request
12. Incorrect server version:
    - `status` - 20000
    - `result` - { "error": "incorrect server version: '`requested server version`'. The server runs version `used server version`" }
    -  HTTP 500 Internal Server Error
13. Unsupported protocol version:
    - `status` - 20001
    - `result` - { "error": "unsupported protocol version: '`unsupported protocol version`'. The server understands protocol versions `supported protocol versions`" }
    -  HTTP 500 Internal Server Error
14. Unsupported operation:
    - `status` - 20002
    - `result` - { "error": "unsupported operation '`unsupported operation`' requested. Supported operations are `supported operations`" }
    -  HTTP 500 Internal Server Error
15. Too many requests:
    - `status` - 20003
    - `result` - { "error": "too many requests" }
    -  HTTP 429 Too Many Requests

### ping

*REQUEST*

- `operation`  - "PING"
- `parameters` - {}

*RESPONSE*

1. Success:
    - `status` - 0
    - `result` - {"data": "PONG"}
    -  HTTP 200 OK
2. Non-empty `parameters`:
    - `status` - 10100
    - `result` - { "error": "'`parameters`' must be an empty object for 'PING'request" }
    -  HTTP 400 Bad Request

### shutdown

*REQUEST*

- `operation`  - "SHUTDOWN"
- `parameters` - {}

*RESPONSE*

1. Success:
    - `status` - 0
    - `result` - {}
    -  HTTP 200 OK
2. Non-empty `parameters`:
    - `status` - 10200
    - `result` - { "error": "`parameters` must be an empty object for 'SHUTDOWN' request" }
    -  HTTP 400 Bad Request
????????????????????? async support ?????????????????
3. Server busy:
    - `status` - 20200
    - `result` - { "error": "server is busy, performing request `request id`" }
    -  HTTP 503 Service Unavailable
????????????????????? async support ?????????????????
4. Failed to close file:
    - `status` - 20201
    - `result` - { "error": "failed to close '`filename`'" }
    -  HTTP 500 Internal Server Error

### import gtiff

*REQUEST*

- `operation`  - "import_gtiff"
- `parameters` - { "file": "`path/to/file.tif`" }

*RESPONSE*

1. Success:
    - `status` - 0
    - `result` - {
        "id": `id`,       - [INT] id of loaded and cached GeoTiff image (stored on the server)
        "metadata": {     - [OBJECT] metadata of the GeoTiff file
            ...
        }
    }
    -  HTTP 200 OK
2. File does not exist:
    - `status` - 20300
    - `result` - { "error": "file '`filename`' does not exist" }
    -  HTTP 404 Not Found
3. Unknown error:
    - `status` - 20301
    - `result` - { "error": "failed to open file '`filename`'" }
    -  HTTP 500 Internal Server Error

### export gtiff

*REQUEST*

- `operation`  - "export_gtiff"
- `parameters` - {
    "id": `id`                    - [INT] id of the index (from cache) to save as a GeoTiff file
    "file": "`path/to/file.tif`"
    }

*RESPONSE*

1. Success:
    - `status` - 0
    - `result` - {}
    -  HTTP 200 OK
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
2. Invalid id:
    - `status` - 10400
    - `result` - { "error": "invalid id '`id`' in `parameters`" }
    -  HTTP 400 Bad Request
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
3. Non-existent id:
    - `status` - 20400
    - `result` - { "error": "id `provided id` does not exist" }
    -  HTTP 404 Not Found
4. Unknown error:
    - `status` - 20401
    - `result` - { "error": "failed to write file `filename`" }
    -  HTTP 500 Internal Server Error

### calculate preview

*REQUEST*

- `operation`  - "calc_preview"
- `parameters` - {
    "ids": [`id_r`, `id_g`, `id_b`]    - [ARRAY of INTs] ids of the files (from cache) to use for generation of the preview, for red, green and blue channels respectively. Exactly 3 values must be specified
    }

*RESPONSE*

1. Success:
    - `status` - 0
    - `result` - {                     - [OBJECT] headers for an HTTP request that needs to be sent to get the binary representation of the preview
        "preview_id": `preview_id`,    - [INT] id of the generated preview (from cache). Must be included in query string of the HTTP request
        "size": `size`,                - [INT] size of the binary representation. Must be included in the "Size" header of the HTTP request
        "hash": `sha256`,              - [INT] hash of the binary representation (sha256 algorithm). Must be included in "Hash" header of the HTTP request
        "width": `width`,              - [INT] width of the image. Must be included in "Width" header of the HTTP request
        "height": `height`             - [INT] height of the image. Must be included in "Height" header of the HTTP request
    }
    -  HTTP 200 OK
2. Invalid id:
    - `status` - 10500
    - `result` - { "error": "invalid id '`id`' in `parameters`" }
    -  HTTP 400 Bad Request
3. Invalid array length:
    - `status` - 10501
    - `result` - { "error": "exactly 3 values must be specified in '`ids`' key" }
    -  HTTP 400 Bad Request
4. Non-existent id:
    - `status` - 20500
    - `result` - { "error": "id `provided id` in '`ids`' does not exist" }
    -  HTTP 404 Not Found
5. Raster sizes do not match:
    - `status` - 20501
    - `result` - { "error": "unable to create a preview from requested ids: rasters do not match in size" }
    -  HTTP 400 Bad Request
6. Unknown error:
    - `status` - 20502
    - `result` - { "error": "unknown error" }
    -  HTTP 500 Internal Server Error

???????????????????? TODO ??????????????????????????
Upon recieving a "status: 0" response, an HTTP/2 request is sent over a separate channel:

GET /previews/?id=`preview_id` HTTP/2
Host: 127.0.0.1
Accept: image/png
Size: `size`
Hash: `sha256`
Width: `width`
Height: `height`

The response follows:

HTTP/2 200 OK
Content-Type: image/png
Content-Length: `size`
Connection: close
Preview-Id: `preview_id`
Hash: `sha256`
Width: `width`
Height: `height`

`binary representation`

If the client encounters an error (e.g. incorrect/invalid `size`, incorrect `sha256`, etc), a new request is sent.
???????????????????? TODO ??????????????????????????

### calculate index

*REQUEST*

- `operation`  - "calc_index"
- `parameters` - {
    "ids": [`id_1`, `id_2`, ...],    - [ARRAY of INTs] ids of the files (from cache) to use for generation of the index. Provided ids are used in the same order as in the index' formula, e.g. for NDVI = (NIR - RED) / (NIR + RED) id_1 is used for NIR and id_2 is used for RED, because in the index formula NIR appeared first.
    "index": "`name of the index`"   - [STRING] name of the index/algorithm to calculate
    }

*RESPONSE*

1. Success:
    - `status` - 0
    - `result` - {
        "id": `id`,       - [INT] id of created spectral index (stored on the server)
        "metadata": {     - [OBJECT] metadata of the index
            ...
        }
    }
    -  HTTP 200 OK
2. Invalid id:
    - `status` - 10600
    - `result` - { "error": "invalid id '`id`' in `parameters`" }
    -  HTTP 400 Bad Request
3. Invalid array length:
    - `status` - 10601
    - `result` - { "error": "exactly `n` values must be specified in '`ids`' key for calculating '`index`' index" }
    -  HTTP 400 Bad Request
4. Non-existent id:
    - `status` - 20600
    - `result` - { "error": "id `provided id` in '`ids`' does not exist" }
    -  HTTP 404 Not Found
5. Raster sizes do not match:
    - `status` - 20601
    - `result` - { "error": "unable to create a preview from requested ids: rasters do not match in size" }
    -  HTTP 400 Bad Request
6. Unknown/unsupported index:
    - `status` - 20602
    - `result` - { "error": "index '`index`' is not supported or unknown" }
    -  HTTP 400 Bad Request
7. Unknown error:
    - `status` - 20603
    - `result` - { "error": "unknown error" }
    -  HTTP 500 Internal Server Error

## Examples

!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
TODO GET requests
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

**Check for connection after start up**

*REQUEST*

POST /api/PING HTTP/2
Content-Type: application/json; charset=utf-8
Content-Length: 88
Accept: application/json; charset=utf-8
Protocol-Version: 2.0.0
Request-ID: 152

{
    "version": "2.0.0",
    "id": 152,
    "operation": "PING",
    "parameters": {}
}

*RESPONSE*

HTTP/2 200 OK
Server: nginx
Content-Type: application/json; charset=utf-8
Content-Length: 104
Protocol-Version: 2.0.0
Request-ID: 152

{
    "version": "2.0.0",
    "id": 152,
    "status": 0,
    "result": {
        "data": "PONG"
    }
}

**Turn the server off**

*REQUEST*

POST /api/SHUTDOWN HTTP/2
Content-Type: application/json; charset=utf-8
Content-Length: 92
Accept: application/json; charset=utf-8
Protocol-Version: 2.0.0
Request-ID: 152

{
    "version": "2.0.0",
    "id": 152,
    "operation": "SHUTDOWN",
    "parameters": {}
}

*RESPONSE*

HTTP/2 200 OK
Server: nginx
Content-Type: application/json; charset=utf-8
Content-Length: 76
Protocol-Version: 2.0.0
Request-ID: 152

{
    "version": "2.0.0",
    "id": 152,
    "status": 0,
    "result": {}
}

**Load Sentinel image**

*REQUEST*

POST /api/import_gtiff HTTP/2
Content-Type: application/json; charset=utf-8
Content-Length: 150
Accept: application/json; charset=utf-8
Protocol-Version: 2.0.0
Request-ID: 152

{
    "version": "2.0.0",
    "id": 152,
    "operation": "import_gtiff",
    "parameters": {
        "file": "/home/user/gis/sentinel/b2.tif"
    }
}

*RESPONSE*

HTTP/2 200 OK
Server: nginx
Content-Type: application/json; charset=utf-8
Content-Length: 564
Protocol-Version: 2.0.0
Request-ID: 152

{
    "version": "2.0.0",
    "id": 152,
    "status": 0,
    "result": {
        "id": 1,
        "metadata": {
            ...
        }
    }
}

**Export a spectral index**

*REQUEST*

POST /api/export_gtiff HTTP/2
Content-Type: application/json; charset=utf-8
Content-Length: 176
Accept: application/json; charset=utf-8
Protocol-Version: 2.0.0
Request-ID: 152

{
    "version": "2.0.0",
    "id": 152,
    "operation": "export_gtiff",
    "parameters": {
        "id": 4,
        "file": "/home/user/gis/landsat/indices/ndci.tif"
    }
}

*RESPONSE*

HTTP/2 200 OK
Server: nginx
Content-Type: application/json; charset=utf-8
Content-Length: 76
Protocol-Version: 2.0.0
Request-ID: 152

{
    "version": "2.0.0",
    "id": 152,
    "status": 0,
    "result": {}
}

**Generate a grayscale preview using the same band for r, g and b**

*REQUEST*

POST /api/calc_preview HTTP/2
Content-Type: application/json; charset=utf-8
Content-Length: 126
Accept: application/json; charset=utf-8
Protocol-Version: 2.0.0
Request-ID: 152

{
    "version": "2.0.0",
    "id": 152,
    "operation": "calc_preview",
    "parameters": {
        "ids": [7, 7, 7]
    }
}

*RESPONSE*

HTTP/2 200 OK
Server: nginx
Content-Type: application/json; charset=utf-8
Content-Length: 259
Protocol-Version: 2.0.0
Request-ID: 152

{
    "version": "1.0.0",
    "id": 152,
    "status": 0,
    "result": {
        "preview_id": 69,
        "size": 3864,
        "hash": "268cd85c83ef066c232d831af0ce6362bf9091b8d9000ac279fbd620df8ce5c2",
        "width": 1024,
        "height": 1024
    }
}

**Create NDCI index**

*REQUEST*

POST /api/calc_index HTTP/2
Content-Type: application/json; charset=utf-8
Content-Length: 146
Accept: application/json; charset=utf-8
Protocol-Version: 2.0.0
Request-ID: 152

{
    "version": "2.0.0",
    "id": 152,
    "operation": "calc_index",
    "parameters": {
        "ids": [3, 4],
        "index": "ndci"
    }
}

*RESPONSE*

HTTP/2 200 OK
Server: nginx
Content-Type: application/json; charset=utf-8
Content-Length: 431
Protocol-Version: 2.0.0
Request-ID: 152

{
    "version": "2.0.0",
    "id": 152,
    "status": 0,
    "result": {
        "id": 6,
        "metadata": {
            ...
        }
    }
}

**Invalid request**

*REQUEST*

POST /api/export_gtiff HTTP/2
Content-Type: application/json; charset=utf-8
Content-Length: 180
Accept: application/json; charset=utf-8
Protocol-Version: 2.0.0
Request-ID: 152

{
    "version": "2.0.0",
    "id": 152,
    "operation": "export_geotiff",
    "parameters": {
        "id": "4",
        "file": "/home/user/gis/landsat/indices/ndci.tif"
    }
}

*RESPONSE*

HTTP/2 400 Bad Request
Server: nginx
Content-Type: application/json; charset=utf-8
Content-Length: 149
Protocol-Version: 2.0.0
Request-ID: 152

{
    "version": "1.0.0",
    "id": 152,
    "status": 10003,
    "result": {
        "error": "unknown operation 'export_geotiff' requested"
    }
}

**Invalid request**

*REQUEST*

POST /api/export_gtiff HTTP/2
Accept: application/json; charset=utf-8
Protocol-Version: 2.0.0
Request-ID: 152

{
    "version": "2.0.0",
    "id": 152,
    "operation": "export_gtiff",
    "parameters": {
        "id": "4",
        "file": "/home/user/gis/landsat/indices/ndci.tif"
    }
}

*RESPONSE*

HTTP/2 400 Bad Request
Server: nginx
Content-Type: application/json; charset=utf-8
Content-Length: 149
Protocol-Version: 2.0.0
Request-ID: 152
Reason: Invalid HTTP Request. Headers "Content-Type, Content-Length" are missing in the request.

