Qt/C++ frontend communicates with Python backend by requests and responses constructed as JSONs according to this protocol.
Each message is prepended with an 4 byte header containing the length of the message. Big-Endian and UTF-8 are used.
Image previews are sent as blobs through a separate channel using HTTP/2 protocol.

## Supported commands

1. PING - check connection
2. SHUTDOWN - turn the server off
3. import_gtiff - load and cache GeoTiff file
4. export_gtiff - save calculated index as GeoTiff file
5. calc_preview - request rgb values to render as a preview. Upon recieving a successful response, the client constructs an HTTP request, sends it over a separate channel and waits for an HTTP response containing the binary representation of the preview
6. calc_index - create a spectral index and cache it

## Message structure

All messages are JSON texts consisting of 4 keys:

**REQUEST**
- `version`     - [STRING] in format of  "x.y.z" indicating the version of the protocol used
- `id`          - [INT]    id of request
- `operation`   - [STRING] type of operation to perform on the backend
- `parameters`  - [OBJECT] parameters to use for `operation`

**RESPONSE**
- `version`     - [STRING] in format of  "x.y.z" indicating the version of the protocol used
- `id`          - [INT]    id of respective request
- `status`      - [INT]    number indicating success or an error
- `result`      - [OBJECT] data generated by respective `operation`, if applicable

If there are no `parameters` or `result`, an empty object is sent.

Status codes follow these general rules:
- 0 means requested operation was successfully performed
- 1xxxx means invalid request (checks for types and request structure)
- 2xxxx means an error on the backend side (logic/other error)
- 100xx and 200xx refer to codes common for all operations
- 1yyxx and 2yyxx refer to codes specific for operation `yy`, numbered as in Supported commands, 0-prefixed

Below are specifics for requests and responses for each supported command. Common keys and status codes are not specified for each operation.

### Common status codes

1. Invalid request structure:
    - `status` - 10000
    - `result` - { "error": "key `invalid key` is unknown" } OR { "error": "key `missing key` is not specified" }
2. Invalid version:
    - `status` - 10001
    - `result` - { "error": "invalid version string" }
3. Invalid id:
    - `status` - 10002
    - `result` - { "error": "invalid request id" }
4. Unknown operation:
    - `status` - 10003
    - `result` - { "error": "unknown operation '`operation`' requested" }
5. Invalid parameters (unknown key in `parameters` object):
    - `status` - 10004
    - `result` - { "error": "invalid key `invalid key` in `parameters`" }
6. Unsupported version:
    - `status` - 20000
    - `result` - { "error": "unsupported version. The server understands protocol version `used protocol version`" }
7. Too many requests:
    - `status` - 20001
    - `result` - { "error": "too many requests" }

### ping

*REQUEST*

- `operation`  - "PING"
- `parameters` - {}

*RESPONSE*
1. Success:
    - `status` - 0
    - `result` - {"data": "PONG"}
2. Non-empty `parameters`:
    - `status` - 10100
    - `result` - { "error": "`parameters` must be an empty object for 'PING' and 'SHUTDOWN' requests" }

### shutdown

*REQUEST*

- `operation`  - "SHUTDOWN"
- `parameters` - {}

*RESPONSE*
1. Success:
    - `status` - 0
    - `result` - {}
2. Non-empty `parameters`:
    - `status` - 10200
    - `result` - { "error": "`parameters` must be an empty object for 'PING' and 'SHUTDOWN' requests" }
3. Server busy:
    - `status` - 20200
    - `result` - { "error": "server is busy, performing request `request id`" }
4. Failed to close file:
    - `status` - 20201
    - `result` - { "error": "failed to close `filename`" }

### import gtiff

*REQUEST*

- `operation`  - "import_gtiff"
- `parameters` - { "file": "`path/to/file.tif`" }

*RESPONSE*
1. Success:
    - `status` - 0
    - `result` - {
        "id": `id`,       - [INT] id of loaded and cached GeoTiff image (stored on the server)
        "metadata": {     - [OBJECT] metadata of the GeoTiff file
            ...
        }
    }
2. File does not exist:
    - `status` - 20300
    - `result` - { "error": "file `filename` does not exist" }
3. Unknown error:
    - `status` - 20301
    - `result` - { "error": "failed to open file `filename`" }

### export gtiff

*REQUEST*

- `operation`  - "export_gtiff"
- `parameters` - {
    "id": `id`                    - [INT] id of the index (from cache) to save as a GeoTiff file
    "file": "`path/to/file.tif`"
    }

*RESPONSE*
1. Success:
    - `status` - 0
    - `result` - {}
2. Invalid id:
    - `status` - 10400
    - `result` - { "error": "invalid id string '`id`' in `parameters`" }
3. Non-existent id:
    - `status` - 20400
    - `result` - { "error": "id `provided id` does not exist" }
4. Unknown error:
    - `status` - 20401
    - `result` - { "error": "failed to write file `filename`" }

### calculate preview

*REQUEST*

- `operation`  - "calc_preview"
- `parameters` - {
    "ids": [`id_r`, `id_g`, `id_b`]    - [ARRAY of INTs] ids of the files (from cache) to use for generation of the preview, for red, green and blue channels respectively. Exactly 3 values must be specified
    }

*RESPONSE*
1. Success:
    - `status` - 0
    - `result` - {                     - [OBJECT] headers for an HTTP request that needs to be sent to get the binary representation of the preview
        "preview_id": `preview_id`,    - [INT] id of the generated preview (from cache). Must be included in query string of the HTTP request
        "size": `size`,                - [INT] size of the binary representation. Must be included in the "X-Size" header of the HTTP request
        "hash": `sha256`,              - [INT] hash of the binary representation (sha256 algorithm). Must be included in "X-Hash" header of the HTTP request
        "width": `width`,              - [INT] width of the image. Must be included in "X-Width" header of the HTTP request
        "height": `height`             - [INT] height of the image. Must be included in "X-Height" header of the HTTP request
    }
2. Invalid id:
    - `status` - 10500
    - `result` - { "error": "invalid id string '`id`' in `parameters`" }
3. Invalid array length:
    - `status` - 10501
    - `result` - { "error": "exactly 3 values must be specified in `ids` key" }
4. Non-existent id:
    - `status` - 20500
    - `result` - { "error": "id `provided id` in `ids` does not exist" }
5. Raster sizes do not match:
    - `status` - 20501
    - `result` - { "error": "unable to create a preview from requested ids: rasters do not match in size" }
6. Unknown error:
    - `status` - 20502
    - `result` - { "error": "unknown error" }

Upon recieving a "status: 0" response, an HTTP/2 request is sent over a separate channel:

GET /previews/?id=`preview_id` HTTP/2
Host: 127.0.0.1
Accept: image/png
X-Size: `size`
X-Hash: `sha256`
X-Width: `width`
X-Height: `height`

The response follows:

HTTP/2 200 OK
Content-Type: image/png
Content-Length: `size`
Connection: close
X-Preview-Id: `preview_id`
X-Hash: `sha256`
X-Width: `width`
X-Height: `height`

`binary representation`

If the client encounters an error (e.g. incorrect/invalid `size`, incorrect `sha256`, etc), a new request is sent.

### calculate index

- `operation`  - "calc_index"
- `parameters` - {
    "ids": [`id_1`, `id_2`, ...],    - [ARRAY of INTs] ids of the files (from cache) to use for generation of the index
    "index": "`name of the index`"   - [STRING] name of the index/algorithm to calculate
    }

*RESPONSE*
1. Success:
    - `status` - 0
    - `result` - {
        "id": `id`,       - [INT] id of created spectral index (stored on the server)
        "metadata": {     - [OBJECT] metadata of the index
            ...
        }
    }
2. Invalid id:
    - `status` - 10600
    - `result` - { "error": "invalid id string '`id`' in `parameters`" }
3. Invalid array length:
    - `status` - 10601
    - `result` - { "error": "exactly `n` values must be specified in `ids` key for calculating `index` index" }
4. Non-existent id:
    - `status` - 20600
    - `result` - { "error": "id `provided id` in `ids` does not exist" }
5. Raster sizes do not match:
    - `status` - 20601
    - `result` - { "error": "unable to create a preview from requested ids: rasters do not match in size" }
6. Unknown/unsupported index:
    - `status` - 20602
    - `result` - { "error": "index `index` is not supported or unknown" }
7. Unknown error:
    - `status` - 20603
    - `result` - { "error": "unknown error" }

## Examples

**Check for connection after start up**

*REQUEST*

{
    "version": "1.0.0",
    "id": 152,
    "operation": "PING",
    "parameters": {}
}

*RESPONSE*

{
    "version": "1.0.0",
    "id": 152,
    "status": 0,
    "result": {
        "data": "PONG"
    }
}

**Turn the server off**

*REQUEST*

{
    "version": "1.0.0",
    "id": 152,
    "operation": "SHUTDOWN",
    "parameters": {}
}

*RESPONSE*

{
    "version": "1.0.0",
    "id": 152,
    "status": 0,
    "result": {}
}

**Load Sentinel image**

*REQUEST*

{
    "version": "1.0.0",
    "id": 152,
    "operation": "import_gtiff",
    "parameters": {
        "file": "/home/user/gis/sentinel/b2.tif"
    }
}

*RESPONSE*

{
    "version": "1.0.0",
    "id": 152,
    "status": 0,
    "result": {
        "id": 1,
        "metadata": {
            ...
        }
    }
}

**Export a spectral index**

*REQUEST*

{
    "version": "1.0.0",
    "id": 152,
    "operation": "export_gtiff",
    "parameters": {
        "id": 4,
        "file": "/home/user/gis/landsat/indices/ndci.tif"
    }
}

*RESPONSE*

{
    "version": "1.0.0",
    "id": 152,
    "status": 0,
    "result": {}
}

**Generate a grayscale preview using the same band for r, g and b**

*REQUEST*

{
    "version": "1.0.0",
    "id": 152,
    "operation": "calc_preview",
    "parameters": {
        "ids": [7, 7, 7]
    }
}

*RESPONSE*

{
    "version": "1.0.0",
    "id": 152,
    "status": 0,
    "result": {
        [
            [123, 123, 123],
            [17, 17, 17],
            [78, 78, 78],
            ...
        ]
    }
}

**Create NDCI index**

*REQUEST*

{
    "version": "1.0.0",
    "id": 152,
    "operation": "calc_index",
    "parameters": {
        "ids": [3, 4],
        "index": "ndci"
    }
}

*RESPONSE*

{
    "version": "1.0.0",
    "id": 152,
    "status": 0,
    "result": {
        "id": 6,
        "metadata": {
            ...
        }
    }
}

**Invalid request**

*REQUEST*

{
    "version": "1.0.0",
    "id": 152,
    "operation": "export_geotiff",
    "parameters": {
        "id": "4",
        "file": "/home/user/gis/landsat/indices/ndci.tif"
    }
}

*RESPONSE*

{
    "version": "1.0.0",
    "id": 152,
    "status": 10003,
    "result": {
        "error": "unknown operation 'export_geotiff' requested"
    }
}