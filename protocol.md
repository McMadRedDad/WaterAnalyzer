**VERSION 3.0.3**

Communication via HTTP messages. The payload is sent as a JSON document in message bodies.

Requests for command execution are sent as POST HTTP/1.1 to /api/`command` endpoint.
Requests for particular resources (image preview, spatial index image, etc.) are sent as GET HTTP/2 to /resource/`type` endpoint with query string id=`id`.

There are two layers of error checking.
Firstly, overall request validity on the HTTP level is checked. This includes correct set of headers, valid JSON body, etc. If any error is caught, a response is sent immediately with an empty body and a "Reason" header containing a description of the error. Otherwise, the protocol proceeds to the next layer.
Secondly, the JSON body itself, if applicable, is checked according to the main part of this protocol and an appropriate response is generated. Alongside the JSON errors, HTTP status codes are utilized as a general clue on the result of the request.

# URL validation

If the request was sent to an unknown endpoint, an HTTP 400 Bad Request is sent with one of the following "Reason" headers:

Reason: Unknown/unsupported command "`unknown command`" requested.
Reason: The requested resource type "`resource type`" is not supported.

For **command execution** requests no query string must be specified. Otherwise, an HTTP 400 Bad Request with an empty body and a "Reason" header is sent:

Reason: No query strings allowed for command execution requests.

For **resource** requests one "id" parameter is obligatory which refers to a resource identifier on the server and is an integer number greater than or equal to zero. Depending on the resource type, extra parameters could be provided, which is defined further in the protocol.

In case of errors, an HTTP 400 Bad Request with an empty body and one of the following "Reason" headers is sent:

Reason: Query string must be provided for resource requests.
Reason: Query string must include "id" parameter for resource requests.
Reason: "id" parameter of the query string must be of integer type.
Reason: Invalid value `invalid id` for "id" parameter of the query string: must be >= 0.

Responses to URL validation errors, including query string errors dependent on the resource type which are defined further in the protocol, are **the only** responses that may not specify mandatory HTTP headers defined below.

# Mandatory HTTP headers

**Command execution** requests must include the following HTTP headers:
- Content-Type: application/json; charset=utf-8
- Content-Length: `request's body length in bytes`
- Accept: application/json; charset=utf-8
- Protocol-Version: `this protocol's version`
- Request-ID: `request id`
Command execution responses must include the following HTTP headers:
- Server: `HTTP server`
- Content-Type: application/json; charset=utf-8 **OR** anything for non-200 responses
- Content-Length: `response's body length in bytes`
- Protocol-Version: `this protocol's version`
- Request-ID: `request id`

**Resource** requests must include the following HTTP headers:
- Accept: `supported formats`
- Protocol-Version: `this protocol's version`
- Request-ID: `request id`
Resource responses must include the following HTTP headers:
- Server: `HTTP server`
- Content-Type: `resource format` **OR** anything for non-200 responses
- Content-Length: `response's body length in bytes`
- Protocol-Version: `this protocol's version`
- Request-ID: `request id`

For different resource requests extra mandatory headers can be defined depending on the resource type.
Any additional headers generated by HTTP servers and clients **do not** violate this protocol.
If not all mandatory headers, including extra resource type dependent ones, are present in a request, HTTP server constructs an HTTP 400 Bad Request response with an empty body, the "Request-ID" header, if present, and a "Reason" header:

Reason: Invalid HTTP Request. Headers "`missing headers`" are missing in the request.

If only the "Content-Length" header is missing, HTTP 411 Length Required is sent instead with the following "Reason" header:

Reason: Invalid HTTP request. "Content-Length" header must be provided.

The mandatory headers' values are considered valid for **command execution** requests if:
- Content-Type and Accept equal to "application/json; charset=utf-8" OR "application/json;charset=utf-8"
- Content-Length is of integer type and is between 2 and 1024 including borders
- Protocol-Version equals to the actual version of this protocol
- Request-ID is of integer type and is greater than or equal to 0

If "Content-Length" header's value is more than 1024, an HTTP 413 Content Too Large response with an empty body and the "Reason" header is sent:

Reason: Invalid value "`provided length`" for "Content-Length" header: must be in [2, 1024] for /api/`command` request.

For other cases an HTTP 400 Bad Request response with an empty body and one of the following "Reason" headers is sent:

Reason: Invalid value "`invalid value`" of "Content-Type" header: must be "application/json; charset=utf-8" or "application/json;charset=utf-8" for /api/`command` request.
Reason: Invalid value "`invalid value`" of "Accept" header: must be "application/json; charset=utf-8" or "application/json;charset=utf-8" for /api/`command` request.
Reason: Invalid type for "Content-Length" header: must be of integer type.
Reason: Invalid value "`provided length`" for "Content-Length" header: must be in [2, 1024] for /api/`command` request.
Reason: Invalid protocol version "`provided version`" in "Protocol-Version" header: used protocol version is "`used protocol version`".
Reason: Invalid type for "Request-ID" header: must be of integer type.
Reason: Invalid value "`value`" of "Request-ID" header: must be >= 0.

The mandatory headers' values are considered valid for **resource** requests if:
- Accept equals to "image/png" for preview requests and "image/tiff" for index requests
- Protocol-Version equals to the actual version of this protocol
- Request-ID is of integer type and is greater than or equal to 0

If any header is invalid, an HTTP 400 Bad Request response with an empty body and one of the following "Reason" headers is sent:

Reason: Invalid value "`invalid value`" of "Accept" header: must be "image/png" for /resource/preview request.
Reason: Invalid value "`invalid value`" of "Accept" header: must be "image/tiff" for /resource/index request.
Reason: Invalid protocol version "`provided version`" in "Protocol-Version" header: used protocol version is "`used protocol version`".
Reason: Invalid type for "Request-ID" header: must be of integer type.
Reason: Invalid value "`value`" of "Request-ID" header: must be >= 0.

# HTTP request body validation

After successfully passing HTTP headers check, the request proceeds to body validation. At this point, it is only checked if the body is of correct type and in a valid format.

For **command execution** (HTTP POST) requests it is checked if a body is a valid JSON document. If not, an HTTP 400 Bad Request with an empty body and the "Reason" header is sent:

Reason: The request's body is not a valid JSON document.

If the body is an empty JSON document, an HTTP 400 Bad Request with an empty body and the "Reason" header is sent:

Reason: The request's body must not be an empty JSON document for command execution requests.

For **resource** (HTTP GET) requests it is checked if body is empty. If not, an HTTP 400 Bad Request with an empty body and the "Reason" header is sent:

Reason: The request's body must be empty for resource requests.

If the request passed body validation, it proceeds to the second layer of error checking related to the JSON part of this protocol.

# Command execution requests
## Supported commands

1. PING             - check connection and get a "PONG" piece of data
2. SHUTDOWN         - turn the server off
3. import_gtiff     - load a GeoTiff file to the server and cache it
4. calc_preview     - request the server to calculate an image preview from cached GeoTiffs
5. calc_index       - create a spectral index and cache it
6. set_satellite    - save what satellite is used in the client's session
7. end_session      - free resources occupied by the client. Indicates the end of the client's session
8. import_metafile  - load a metadata file

## Message structure

All JSON documents consist of 5 keys:

**REQUEST**
- `proto_version`     - [STRING] in format of  "x.y.z" indicating the version of the protocol used
- `server_version`    - [STRING] in format of  "x.y.z" indicating the version of the server running
- `id`                - [INT]    id of request, >= 0
- `operation`         - [STRING] type of operation to perform on the backend
- `parameters`        - [OBJECT] parameters to use for `operation`

**RESPONSE**
- `proto_version`     - [STRING] in format of  "x.y.z" indicating the version of the protocol used
- `server_version`    - [STRING] in format of  "x.y.z" indicating the version of the server running
- `id`                - [INT]    id of respective request, >= 0
- `status`            - [INT]    number indicating success or an error
- `result`            - [OBJECT] data generated by respective `operation`, if applicable

If there are no actual `parameters` or `result` data, an empty object is sent for that key.

Status codes follow these general rules:
- 0 means requested operation was successfully performed
- 1xxxx means invalid request (checks for types and request structure)
- 2xxxx means an error on the server side (logic/other error)
- 100xx and 200xx refer to codes common for all operations
- 1yyxx and 2yyxx refer to codes specific for operation `yy`, numbered as in Supported commands, 0-prefixed

Below are specifics for requests and responses for each supported command.

## Common status codes

1. Invalid request structure:
    - `status` - 10000
    - `result` - { "error": "key '`unknown key`' is unknown" }
    -  HTTP 400 Bad Request
2. Invalid request structure:
    - `status` - 10001
    - `result` - { "error": "keys '`missing keys`' are not specified" }
    -  HTTP 400 Bad Request
3. Invalid protocol version string:
    - `status` - 10002
    - `result` - { "error": "invalid protocol version string: '`invalid string`'" }
    -  HTTP 400 Bad Request
4. Invalid server version string:
    - `status` - 10003
    - `result` - { "error": "invalid server version string: '`invalid string`'" }
    -  HTTP 400 Bad Request
5. Invalid id:
    - `status` - 10004
    - `result` - { "error": "invalid request id: '`invalid id`'" }
    -  HTTP 400 Bad Request
6. Unknown operation:
    - `status` - 10005
    - `result` - { "error": "unknown operation '`operation`' requested" }
    -  HTTP 400 Bad Request
7. Invalid parameters:
    - `status` - 10006
    - `result` - { "error": "invalid '`parameters`' key: must be of JSON object type }
    -  HTTP 400 Bad Request
8. Invalid parameters (missing key in `parameters` object):
    - `status` - 10007
    - `result` - { "error": "keys '`missing keys`' are not specified in '`parameters`' for '`operation`' operation }
    -  HTTP 400 Bad Request
9. Invalid parameters (unknown key in `parameters` object):
    - `status` - 10008
    - `result` - { "error": "unknown key '`unknown key`' in '`parameters`' for '`operation`' operation" }
    -  HTTP 400 Bad Request
10. Incorrect protocol version:
    - `status` - 10009
    - `result` - { "error": "incorrect protocol version: '`requested protocol version`'. The current protocol version is `used protocol version`" }
    -  HTTP 400 Bad Request
11. Mismatching keys:
    - `status` - 10010
    - `result` - { "error": "values '`mismatched key`' do not match in request and response" }
    -  HTTP 400 Bad Request
12. Incorrect server version:
    - `status` - 20000
    - `result` - { "error": "incorrect server version: '`requested server version`'. The server runs version `used server version`" }
    -  HTTP 500 Internal Server Error
13. Unsupported protocol version:
    - `status` - 20001
    - `result` - { "error": "unsupported protocol version: '`unsupported protocol version`'. The server understands protocol versions `supported protocol versions`" }
    -  HTTP 500 Internal Server Error
14. Unsupported operation:
    - `status` - 20002
    - `result` - { "error": "unsupported operation '`unsupported operation`' requested. Supported operations are `supported operations`" }
    -  HTTP 500 Internal Server Error
15. Too many requests:
    - `status` - 20003
    - `result` - { "error": "too many requests" }
    -  HTTP 429 Too Many Requests
16. No satellite set:
    - `status` - 20004
    - result - { "error": "request `received request` was received before 'set_satellite' request }
    - HTTP 500 Internal Server Error

## ping

*REQUEST*

- `operation`  - "PING"
- `parameters` - {}

*RESPONSE*

1. Success:
    - `status` - 0
    - `result` - { "data": "PONG" }
    -  HTTP 200 OK
2. Non-empty parameters:
    - `status` - 10100
    - `result` - { "error": "'`parameters`' must be an empty object for 'PING'request" }
    -  HTTP 400 Bad Request

## shutdown

*REQUEST*

- `operation`  - "SHUTDOWN"
- `parameters` - {}

*RESPONSE*

1. Success:
    - `status` - 0
    - `result` - {}
    -  HTTP 200 OK
2. Non-empty parameters:
    - `status` - 10200
    - `result` - { "error": "'`parameters`' must be an empty object for 'SHUTDOWN' request" }
    -  HTTP 400 Bad Request
????????????????????? async support ?????????????????
3. Server busy:
    - `status` - 20200
    - `result` - { "error": "server is busy, performing request `request id`" }
    -  HTTP 503 Service Unavailable
????????????????????? async support ?????????????????
4. Failed to close file:
    - `status` - 20201
    - `result` - { "error": "failed to close '`filename`'" }
    -  HTTP 500 Internal Server Error

## import gtiff

**Must** be sent only after 'set_satellite' request.

*REQUEST*

- `operation`  - "import_gtiff"
- `parameters` - {
    "file": "`/path/to/file.tif`",  **!!!no local paths for remote servers; fine for now!!!**
    "band": `band name`             - [STRING] what spectral band the file represents
}

*RESPONSE*

1. Success:
    - `status` - 0
    - `result` - {
        "file": "`/path/to/loaded/file.tif`",           - [STRING] path of the file from the request  **!!!no local paths for remote servers; fine for now!!!**
        "band": `band`,                                 - [INT] band of loaded GeoTiff image
        "info": {                                       - [OBJECT] description of the GeoTiff image
            "width": `width`,                           - [INT] width of the image in pixels
            "height": `height`,                         - [INT] height of the image in pixels
            "projection": `projection`,                 - [STRING] in format "`authority`:`code`" identifying projection used
            "unit": `measure unit`,                     - [STRING] the unit used in the image
            "origin": [`x`, `y`],                       - [ARRAY of DOUBLEs] coordinates of the origin of the image
            "pixel_size": [`size on x`, `size on y`]    - [ARRAY of DOUBLEs] size of the image pixel in measurement units
        }
    }
    -  HTTP 200 OK
2. Invalid band type:
    - `status` - 10300
    - `result` - { "error": "invalid '`band`' key: must be of string type" }
    -  HTTP 400 Bad Request
3. Not a GeoTiff:
    - `status` - 20300
    - `result` - { "error": "provided file '`file`' is not a GeoTiff image" }
    -  HTTP 500 Internal Server Error
4. Unknown error:
    - `status` - 20301
    - `result` - { "error": "failed to open file '`filename`'" }
    -  HTTP 500 Internal Server Error

## calculate preview

**Must** be sent only after 'set_satellite' request.

*REQUEST*

- `operation`  - "calc_preview"
- `parameters` - {
    "index": `index` or "nat_col"   - [STRING] what index to calculate preview for. "nat_col" refers to natural color visualization
    "width": `needed width`,        - [INT] width of the preview that the client preffers, > 0
    "height": `needed height`       - [INT] height of the preview that the client preffers, > 0
}

*RESPONSE*

1. Success:
    - `status` - 0
    - `result` - {                          - [OBJECT] data to be included in the HTTP GET request 
        "url": "/resource/preview?id=`id`   - [STRING] url to be used for HTTP GET request
    }
    -  HTTP 200 OK
2. Invalid index type:
    - `status` - 10400
    - `result` - { "error": "invalid '`index`' key: must be of string type" }
    -  HTTP 400 Bad Request
3. Invalid width or height type:
    - `status` - 10401
    - `result` - { "error": "invalid '`width or height`' key: must be of integer type" }
    -  HTTP 400 Bad Request
4. Invalid width or height:
    - `status` - 10402
    - `result` - { "error": "invalid `width or height` '`invalid value`' in '`width or height`' key: must be > 0" }
    -  HTTP 400 Bad Request
5. Unknown/unsupported index:
    - `status` - 20400
    - `result` - { "error": "index '`index`' is not supported or unknown" }
    -  HTTP 400 Bad Request
6. Index not calculated:
    - `status` - 20401
    - `result` - { "error": "`index or satellite model band` '`index name or band number`' is not `calculated or loaded` but needed for preview generation" }
    -  HTTP 500 Internal Server Error
7. Unknown error:
    - `status` - 20402
    - `result` - { "error": "unknown error" }
    -  HTTP 500 Internal Server Error

## calculate index

**Must** be sent only after 'set_satellite' request.

*REQUEST*

- `operation`  - "calc_index"
- `parameters` - {
    "index": "`name of the index`"  - [STRING] name of the index/algorithm to calculate
}

*RESPONSE*

1. Success:
    - `status` - 0
    - `result` - {
        "url": "/resource/index?id=`id`",               - [STRING] url to be used for HTTP GET request
        "index": `name of the index`    **!!!to be reconsidered for RESTful in the future!!!**
        "info": {                                       - [OBJECT] description of the GeoTiff image
            "width": `width`,                           - [INT] width of the image in pixels
            "height": `height`,                         - [INT] height of the image in pixels
            "projection": `projection`,                 - [STRING] in format "`authority`:`code`" identifying projection used
            "unit": `measure unit`,                     - [STRING] the unit used in the image
            "origin": [`x`, `y`],                       - [ARRAY of DOUBLEs] coordinates of the origin of the image
            "pixel_size": [`size on x`, `size on y`],   - [ARRAY of DOUBLEs] size of the image pixel in measurement units
            "min": `min pixel value`,                   - [FLOAT] minimum pixel value
            "max": `max pixel value`,                   - [FLOAT] maximum pixel value
            "mean": `mean pixel value`,                 - [FLOAT] mean pixel value
            "stdev": `standard deviation`,              - [FLOAT] standard deviation of pixel values
            "ph_unit": `physical unit`                  - [STRING] physycal unit that pixel values represent, if any
        }
    }
    -  HTTP 200 OK
2. Invalid index type:
    - `status` - 10500
    - `result` - { "error": "invalid '`index`' key: must be of string type" }
    -  HTTP 400 Bad Request
3. Unknown/unsupported index:
    - `status` - 20500
    - `result` - { "error": "index '`index`' is not supported or unknown" }
    -  HTTP 400 Bad Request
4. Not supported by satellite:
    - `status` - 20501
    - `result` - { "error": "index '`index`' is not supported for `satellite model` `proc level`" }
    -  HTTP 500 Internal Server Error
5. Not enough bands:
    - `status` - 20502
    - `result` - { "error": "unable to calculate index '`index`': `satellite model` bands number `needed bands` are needed" }
    -  HTTP 500 Internal Server Error
6. Unknown error:
    - `status` - 20503
    - `result` - { "error": "unknown error" }
    -  HTTP 500 Internal Server Error

## set satellite

*REQUEST*

- `operation`  - "set_satellite"
- `parameters` - {
    "satellite": "`satellite model`",   - [STRING] what satellite is used in the client's session
    "proc_level": `processing level`    - [STRING] what processing level is used in the client's session
    }

*RESPONSE*

1. Success:
    - `status` - 0
    - `result` - {}
    -  HTTP 200 OK
2. Invalid satellite type:
    - `status` - 10600
    - `result` - { "error": "invalid '`satellite`' key: must be of string type" }
    -  HTTP 400 Bad Request
3. Invalid proc_level type:
    - `status` - 10601
    - `result` - { "error": "invalid '`proc_level`' key: must be of string type" }
    -  HTTP 400 Bad Request
4. Unsupported satellite:
    - `status` - 20600
    - `result` - { "error": "unsupported satellite model: '`satellite`'" }
    -  HTTP 500 Internal Server Error
5. Invalid proc_level:
    - `status` - 20601
    - `result` - { "error": "unknown/unsupported processing level '`proc_level`' for '`satellite`'" }
    -  HTTP 400 Bad Request

## end session

*REQUEST*

- `operation`  - "end_session"
- `parameters` - {}

*RESPONSE*

1. Success:
    - `status` - 0
    - `result` - {}
    -  HTTP 200 OK
2. Non-empty parameters:
    - `status` - 10700
    - `result` - { "error": "'`parameters`' must be an empty object for 'end_session'request" }
    -  HTTP 400 Bad Request
3. Server busy
    - `status` - 20700
    - `result` - { "error": "unable to end session: a request is being processed" }
    -  HTTP 409 Conflict

## import metadata

**Must** be sent only after 'set_satellite' request.

*REQUEST*

- `operation`  - "import_metafile"
- `parameters` - {
    "file": "`/path/to/file`"  **!!!no local paths for remote servers; fine for now!!!**
}

*RESPONSE*

1. Success:
    - `status` - 0
    - `result` - {
        "loaded": `number`  - [INT] how many datasets the metadata was read for
    }
    -  HTTP 200 OK
2. Invalid/wrong file:
    - `status` - 20800
    - `result` - { "error": "metadata file '`filename`' is invalid, unsupported or does not contain calibration coefficients" }
    -  HTTP 500 Internal Server Error
3. Unknown error:
    - `status` - 20801
    - `result` - { "error": "failed to open metadata file '`filename`'" }
    -  HTTP 500 Internal Server Error

## HTTP and JSON cross-validation

If applicable to the request type e.g. for command execution requests, after a request successfully passes the HTTP error checking layer and the 'client' part of the JSON error checking layer (status code 1xxxx errors) which guarantees that the JSON payload contains a valid request according to this protocol, some HTTP request's parts are compared to certain JSON payload's keys. The following comparisons are performed:

- HTTP endpoint and JSON `operation` key
- HTTP "Protocol-Version" header and JSON `proto_version` key
- HTTP "Request-ID" header and JSON `id` key

If values in any pair mismatch or refer to different entities (for example, the request was sent to /api/ping, but the `operation` key contains 'export_gtiff'), an HTTP 400 Bad Request is sent with the same payload as in the request and one of the "Reason" headers:

Reason: Requested operation "`operation`" does not match to the endpoint "/api/`command`".
Reason: Protocol versions do not match in HTTP header and JSON payload: "`version in header`" and "`version in body`".
Reason: Request ids do not match in HTTP header and JSON payload: "`id in header`" and "`id in body`".

# Resource requests

The following resource endpoints are supported:
- /resource/preview     - for 8bit PNG previews of GeoTiff images
- /resource/index       - for GeoTiff images

All resource requests are constructed as HTTP/2 GET requests with an empty body, headers defined in Mandatory HTTP headers and possibly extra headers depending on the resource type, and a query string with a mandatory `id` parameter equal to an integer number > 0 and possibly extra parameters depending on the resource type.

## Preview

Upon recieving a "status: 0" response for `calc_preview` request, the client is free to construct a resource request to get the actual preview image:

GET /resource/preview?id=`id`&sb=`0 | 1` HTTP/2
Accept: image/png
Protocol-Version: `this protocol's version`
Request-ID: `id`


Value for "id" parameter is taken from the server's response to the respective "calc_preview" request.
The "sb" parameter stands for "scalebar" and defines whether a scalebar should be generated for the preview. It can be either '0' (no scalebar) or '1' (generate scalebar).

The response follows:

HTTP/2 200 OK
Server: `HTTP server`
Content-Type: image/png
Content-Length: `response's body length in bytes`
Protocol-Version: `this protocol's version`
Request-ID: `request's id`
Width: `width`
Height: `height`

`binary representation`

Before processing the resource request, the server checks received query string for preview-specific parameters and in case of errors sends an HTTP 400 Bad Request with an empty body and one of the following "Reason" headers:

Reason: Query string must include "sb" parameter for preview requests.
Reason: Query string must only include "id" and "sb" parameters for preview requests.
Reason: "sb" parameter of the query string must be either 0 or 1.

If the preview with requested id is not grayscale and "sb" parameter equals to '1', an HTTP 400 Bad Request with an empty body and a "Reason" header is sent:

Reason: Unable to generate a scalebar for a non-grayscale preview.

If there is no preview with requested URL, an HTTP 404 Not Found with an empty body and a "Reason" header is sent:

Reason: Requested preview "`request url`" does not exist.

## Index

Requests for indices are ment to get the actual geographical image and save it on the client's machine. No extra mandatory headers or query string parameters are defined.

GET /resource/index?id=`id` HTTP/2
Accept: image/tiff
Protocol-Version: `this protocol's version`
Request-ID: `id`


The response follows:

HTTP/2 200 OK
Server: `HTTP server`
Content-Type: image/tiff
Content-Length: `response's body length in bytes`
Protocol-Version: `this protocol's version`
Request-ID: `request's id`

`binary representation`

Before processing the resource request, the server checks if received query string has only "id" parameter. Otherwise, the server sends an HTTP 400 Bad Request with an empty body and a "Reason" header:

Reason: Query string must only include "id" parameter for index requests.

If there is no index with requested URL, an HTTP 404 Not Found with an empty body and a "Reason" header is sent:

Reason: Requested index "`request url`" does not exist.

# Examples

!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
TODO GET requests
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

**Check for connection after start up**

*REQUEST*

POST /api/PING HTTP/1.1
Content-Type: application/json; charset=utf-8
Content-Length: 88
Accept: application/json; charset=utf-8
Protocol-Version: 2.0.0
Request-ID: 152

{
    "proto_version": "2.0.0",
    "server_version": "1.0.0",
    "id": 152,
    "operation": "PING",
    "parameters": {}
}

*RESPONSE*

HTTP/2 200 OK
Server: nginx
Content-Type: application/json; charset=utf-8
Content-Length: 104
Protocol-Version: 2.0.0
Request-ID: 152

{
    "proto_version": "2.0.0",
    "server_version": "1.0.0",
    "id": 152,
    "status": 0,
    "result": {
        "data": "PONG"
    }
}

**Turn the server off**

*REQUEST*

POST /api/SHUTDOWN HTTP/1.1
Content-Type: application/json; charset=utf-8
Content-Length: 92
Accept: application/json; charset=utf-8
Protocol-Version: 2.0.0
Request-ID: 152

{
    "proto_version": "2.0.0",
    "server_version": "1.0.0",
    "id": 152,
    "operation": "SHUTDOWN",
    "parameters": {}
}

*RESPONSE*

HTTP/2 200 OK
Server: nginx
Content-Type: application/json; charset=utf-8
Content-Length: 76
Protocol-Version: 2.0.0
Request-ID: 152

{
    "proto_version": "2.0.0",
    "server_version": "1.0.0",
    "id": 152,
    "status": 0,
    "result": {}
}

**Load Sentinel image**

*REQUEST*

POST /api/import_gtiff HTTP/1.1
Content-Type: application/json; charset=utf-8
Content-Length: 150
Accept: application/json; charset=utf-8
Protocol-Version: 2.0.0
Request-ID: 152

{
    "proto_version": "2.0.0",
    "server_version": "1.0.0",
    "id": 152,
    "operation": "import_gtiff",
    "parameters": {
        "file": "/home/user/gis/sentinel/b2.tif"
    }
}

*RESPONSE*

HTTP/2 200 OK
Server: nginx
Content-Type: application/json; charset=utf-8
Content-Length: 564
Protocol-Version: 2.0.0
Request-ID: 152

{
    "proto_version": "2.0.0",
    "server_version": "1.0.0",
    "id": 152,
    "status": 0,
    "result": {
        "id": 1,
        "metadata": {
            ...
        }
    }
}

**Export a spectral index**

*REQUEST*

POST /api/export_gtiff HTTP/1.1
Content-Type: application/json; charset=utf-8
Content-Length: 176
Accept: application/json; charset=utf-8
Protocol-Version: 2.0.0
Request-ID: 152

{
    "proto_version": "2.0.0",
    "server_version": "1.0.0",
    "id": 152,
    "operation": "export_gtiff",
    "parameters": {
        "id": 4,
        "file": "/home/user/gis/landsat/indices/ndci.tif"
    }
}

*RESPONSE*

HTTP/2 200 OK
Server: nginx
Content-Type: application/json; charset=utf-8
Content-Length: 76
Protocol-Version: 2.0.0
Request-ID: 152

{
    "proto_version": "2.0.0",
    "server_version": "1.0.0",
    "id": 152,
    "status": 0,
    "result": {}
}

**Generate a grayscale preview using the same band for r, g and b**

*REQUEST*

POST /api/calc_preview HTTP/1.1
Content-Type: application/json; charset=utf-8
Content-Length: 126
Accept: application/json; charset=utf-8
Protocol-Version: 2.0.0
Request-ID: 152

{
    "proto_version": "2.0.0",
    "server_version": "1.0.0",
    "id": 152,
    "operation": "calc_preview",
    "parameters": {
        "ids": [7, 7, 7]
    }
}

*RESPONSE*

HTTP/2 200 OK
Server: nginx
Content-Type: application/json; charset=utf-8
Content-Length: 259
Protocol-Version: 2.0.0
Request-ID: 152

{
    "proto_version": "2.0.0",
    "server_version": "1.0.0",
    "id": 152,
    "status": 0,
    "result": {
        "preview_id": 69,
        "size": 3864,
        "hash": "268cd85c83ef066c232d831af0ce6362bf9091b8d9000ac279fbd620df8ce5c2",
        "width": 1024,
        "height": 1024
    }
}

**Create NDCI index**

*REQUEST*

POST /api/calc_index HTTP/1.1
Content-Type: application/json; charset=utf-8
Content-Length: 146
Accept: application/json; charset=utf-8
Protocol-Version: 2.0.0
Request-ID: 152

{
    "proto_version": "2.0.0",
    "server_version": "1.0.0",
    "id": 152,
    "operation": "calc_index",
    "parameters": {
        "ids": [3, 4],
        "index": "ndci"
    }
}

*RESPONSE*

HTTP/2 200 OK
Server: nginx
Content-Type: application/json; charset=utf-8
Content-Length: 431
Protocol-Version: 2.0.0
Request-ID: 152

{
    "proto_version": "2.0.0",
    "server_version": "1.0.0",
    "id": 152,
    "status": 0,
    "result": {
        "id": 6,
        "metadata": {
            ...
        }
    }
}

**Invalid request**

*REQUEST*

POST /api/export_gtiff HTTP/1.1
Content-Type: application/json; charset=utf-8
Content-Length: 180
Accept: application/json; charset=utf-8
Protocol-Version: 2.0.0
Request-ID: 152

{
    "proto_version": "2.0.0",
    "server_version": "1.0.0",
    "id": 152,
    "operation": "export_geotiff",
    "parameters": {
        "id": "4",
        "file": "/home/user/gis/landsat/indices/ndci.tif"
    }
}

*RESPONSE*

HTTP/2 400 Bad Request
Server: nginx
Content-Type: application/json; charset=utf-8
Content-Length: 149
Protocol-Version: 2.0.0
Request-ID: 152

{
    "proto_version": "2.0.0",
    "server_version": "1.0.0",
    "id": 152,
    "status": 10003,
    "result": {
        "error": "unknown operation 'export_geotiff' requested"
    }
}

**Invalid request**

*REQUEST*

POST /api/export_gtiff HTTP/1.1
Accept: application/json; charset=utf-8
Protocol-Version: 2.0.0
Request-ID: 152

{
    "proto_version": "2.0.0",
    "server_version": "1.0.0",
    "id": 152,
    "operation": "export_gtiff",
    "parameters": {
        "id": "4",
        "file": "/home/user/gis/landsat/indices/ndci.tif"
    }
}

*RESPONSE*

HTTP/2 400 Bad Request
Server: nginx
Content-Type: application/json; charset=utf-8
Content-Length: 0
Protocol-Version: 2.0.0
Request-ID: 152
Reason: Invalid HTTP Request. Headers "Content-Type, Content-Length" are missing in the request.
